<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proforma Ma Cuisine  </title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #60a5fa;
      --dark: #1c1e21;
      --dark-light: #242526;
      --darker: #18191a;
      --text: #e4e6eb;
      --text-secondary: #b0b3b8;
      --card-bg: #242526;
      --card-border: #3a3b3c;
      --success: #31a24c;
      --warning: #f7b928;
      --danger: #f02849;
      --online: #31a24c;
      --offline: #b0b3b8;
      --sidebar-width: 250px;
      --header-height: 60px;
      --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1);
    }

    [data-theme="light"] {
      --dark: #f0f2f5;
      --dark-light: #ffffff;
      --darker: #e4e6eb;
      --text: #050505;
      --text-secondary: #65676b;
      --card-bg: #ffffff;
      --card-border: #dddfe2;
    }

    [dir="rtl"] {
      direction: rtl;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* View Invoice Modal */
    #view-invoice-modal .modal-content {
      max-width: 800px;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .invoice-info {
      background: var(--darker);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .invoice-info div {
      margin-bottom: 8px;
    }

    .invoice-info div:last-child {
      margin-bottom: 0;
    }

    .invoice-notes {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid var(--card-border);
    }

    /* Product Form */
    #product-form .form-group {
      margin-bottom: 20px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--dark);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
      transition: background-color 0.3s ease;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
      padding-top: var(--header-height);
      transition: var(--transition);
      opacity: 1;
      transform: translateY(0);
    }

    .top-navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--header-height);
      background-color: var(--dark-light);
      display: flex;
      align-items: center;
      padding: 0 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      z-index: 100;
      transition: var(--transition);
    }

    .logo {
      display: flex;
      align-items: center;
      margin-right: 20px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }

    .logo-icon svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
    }

    .search-container {
      flex: 1;
      max-width: 500px;
      margin: 0 20px;
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      background-color: var(--darker);
      border: none;
      border-radius: 20px;
      color: var(--text);
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .search-box input:focus {
      outline: none;
      background-color: var(--card-bg);
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .nav-icons {
      display: flex;
      align-items: center;
    }

    .nav-icon {
      position: relative;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--darker);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      cursor: pointer;
      transition: var(--transition);
    }

    .nav-icon:hover {
      background-color: var(--card-border);
    }

    .icon-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger);
      color: white;
      font-size: 0.7rem;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .language-toggle {
      margin: 0 15px;
      display: flex;
      align-items: center;
      background: var(--darker);
      border-radius: 20px;
      padding: 5px;
    }

    .lang-btn {
      padding: 5px 15px;
      border-radius: 15px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    .lang-btn.active {
      background: var(--primary);
      color: white;
    }

    .profile-menu {
      position: relative;
      margin-left: 15px;
    }

    .profile-btn {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 20px;
      transition: var(--transition);
    }

    .profile-btn:hover {
      background-color: var(--darker);
    }

    .profile-img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      margin-right: 8px;
    }

    .profile-name {
      font-weight: 500;
      font-size: 0.9rem;
      margin-right: 8px;
    }

    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: var(--dark-light);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 220px;
      padding: 10px 0;
      margin-top: 10px;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: var(--transition);
    }

    .dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      color: var(--text);
      text-decoration: none;
      transition: var(--transition);
    }

    .dropdown-item:hover {
      background-color: var(--darker);
    }

    .dropdown-item i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .divider {
      height: 1px;
      background-color: var(--card-border);
      margin: 5px 0;
    }

    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--dark-light);
      height: calc(100vh - var(--header-height));
      position: fixed;
      left: 0;
      padding: 20px 0;
      overflow-y: auto;
      transition: var(--transition);
      z-index: 90;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
    }

    .menu-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      color: var(--text);
      text-decoration: none;
      border-radius: 0 8px 8px 0;
      margin: 5px 10px;
      transition: var(--transition);
      position: relative;
      cursor: pointer;
    }

    .menu-item:hover, .menu-item.active {
      background-color: var(--darker);
    }

    .menu-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background-color: var(--primary);
      border-radius: 0 4px 4px 0;
    }

    .menu-item i {
      margin-right: 15px;
      width: 24px;
      text-align: center;
      font-size: 1.1rem;
    }

    .menu-title {
      font-weight: 500;
    }

    .sidebar-footer {
      padding: 20px;
      margin-top: auto;
      border-top: 1px solid var(--card-border);
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--darker);
      border-radius: 20px;
      padding: 5px;
      margin-bottom: 15px;
    }

    .theme-btn {
      flex: 1;
      text-align: center;
      padding: 8px;
      border-radius: 15px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .theme-btn.active {
      background: var(--primary);
      color: white;
    }

    .help-box {
      background: var(--darker);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }

    .help-title {
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    .help-title i {
      margin-right: 10px;
    }

    .help-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 15px;
    }

    .help-btn {
      display: block;
      width: 100%;
      padding: 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .help-btn:hover {
      background: var(--primary-dark);
    }

    .main-content {
      flex: 1;
      padding: 25px;
      margin-left: var(--sidebar-width);
      transition: var(--transition);
    }

    .page {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition);
    }

    .page.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .page-title {
      font-size: 1.75rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }

    .page-title i {
      margin-right: 15px;
      color: var(--primary);
    }

    .page-subtitle {
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .stat-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
    }

    .stat-icon.invoices {
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
    }

    .stat-icon.products {
      background: rgba(96, 165, 250, 0.15);
      color: var(--secondary);
    }

    .stat-icon.revenue {
      background: rgba(247, 185, 40, 0.15);
      color: var(--warning);
    }

    .stat-icon.clients {
      background: rgba(240, 40, 73, 0.15);
      color: var(--danger);
    }

    .stat-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .stat-change.neutral {
      color: var(--text-secondary);
    }

    .stat-change i {
      margin-right: 5px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .action-card {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
    }

    .action-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .action-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 1.5rem;
    }

    .action-card:nth-child(1) .action-icon {
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
    }

    .action-card:nth-child(2) .action-icon {
      background: rgba(96, 165, 250, 0.15);
      color: var(--secondary);
    }

    .action-card:nth-child(3) .action-icon {
      background: rgba(247, 185, 40, 0.15);
      color: var(--warning);
    }

    .action-card:nth-child(4) .action-icon {
      background: rgba(240, 40, 73, 0.15);
      color: var(--danger);
    }

    .action-title {
      font-weight: 600;
      margin-bottom: 10px;
    }

    .action-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .recent-section {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .view-all {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .view-all:hover {
      text-decoration: underline;
    }

    .invoice-list {
      list-style: none;
    }

    .invoice-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid var(--card-border);
    }

    .invoice-item:last-child {
      border-bottom: none;
    }

    .invoice-info {
      flex: 1;
    }

    .invoice-number {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .invoice-client {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .invoice-date {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .invoice-amount {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .invoice-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-paid {
      background: rgba(49, 162, 76, 0.15);
      color: var(--success);
    }

    .status-pending {
      background: rgba(247, 185, 40, 0.15);
      color: var(--warning);
    }

    .status-draft {
      background: rgba(176, 179, 184, 0.15);
      color: var(--text-secondary);
    }

    .status-delivered {
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
    }

    .status-installed {
      background: rgba(139, 92, 246, 0.15);
      color: #8b5cf6;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .btn {
      padding: 10px 20px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover {
      background-color: var(--primary-dark);
    }

    .btn-secondary {
      background-color: var(--card-border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background-color: var(--darker);
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-warning {
      background-color: var(--warning);
      color: white;
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .btn-info {
      background-color: #8b5cf6;
      color: white;
    }

    .btn-info:hover {
      background-color: #7c3aed;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    .table-container {
      background-color: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--card-border);
    }

    .table-title {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .table-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .table-controls input, .table-controls select {
      padding: 8px 12px;
      background-color: var(--darker);
      border: none;
      border-radius: 20px;
      color: var(--text);
      font-size: 0.9rem;
      min-width: 150px;
    }

    .table-controls .search-box {
      position: relative;
    }

    .table-controls .search-box input {
      padding-left: 35px;
      width: 200px;
    }

    .table-controls .search-box .search-icon {
      left: 12px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      text-align: left;
      padding: 15px 20px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--card-border);
    }

    .table td {
      padding: 15px 20px;
      border-bottom: 1px solid var(--card-border);
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .table tr:hover td {
      background-color: var(--darker);
    }

    .action-cell {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--darker);
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
    }

    .action-btn:hover {
      background-color: var(--primary);
      color: white;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--card-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(30px);
      transition: var(--transition);
    }

    .modal.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--card-border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      background-color: var(--darker);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
    }

    .invoice-editor {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .invoice-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .lines-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    .lines-table th {
      text-align: left;
      padding: 10px;
      background-color: var(--darker);
      font-weight: 500;
    }

    .lines-table td {
      padding: 10px;
      border-bottom: 1px solid var(--card-border);
    }

    .lines-table input, .lines-table select {
      width: 100%;
      padding: 8px;
      background-color: var(--darker);
      border: 1px solid var(--card-border);
      border-radius: 4px;
      color: var(--text);
    }

    .lines-table .del-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .invoice-totals {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
    }

    .totals-table {
      width: 300px;
      border-collapse: collapse;
    }

    .totals-table td {
      padding: 8px;
      border-bottom: 1px solid var(--card-border);
    }

    .totals-table tr:last-child td {
      border-bottom: none;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .mono {
      font-family: monospace;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .settings-card {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      transition: var(--transition);
    }

    .settings-card-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .settings-card-header i {
      font-size: 1.5rem;
      margin-right: 15px;
      color: var(--primary);
    }

    .settings-card-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .settings-card-body {
      margin-bottom: 20px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      background-color: var(--dark-light);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      z-index: 2000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 4px solid var(--success);
    }

    .notification.error {
      border-left: 4px solid var(--danger);
    }

    .notification.warning {
      border-left: 4px solid var(--warning);
    }

    .notification i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .notification .close {
      margin-left: 15px;
      cursor: pointer;
      opacity: 0.7;
    }

    .notification .close:hover {
      opacity: 1;
    }

    .progress-container {
      height: 4px;
      background-color: var(--darker);
      border-radius: 2px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--primary);
      width: 0;
      transition: width 0.3s ease;
    }

    .filter-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-size: 0.9rem;
      margin-bottom: 5px;
      color: var(--text-secondary);
    }

    .filter-group select, .filter-group input {
      padding: 8px 12px;
      background-color: var(--darker);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--text);
    }

    /* Product Modal */
    #product-modal .form-group {
      margin-bottom: 15px;
    }

    #product-modal .modal-content {
      max-width: 500px;
    }

    #product-modal .modal-body {
      padding: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .detail-view {
      background: var(--darker);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .detail-view h3 {
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--card-border);
    }

    .detail-item {
      display: flex;
      margin-bottom: 10px;
    }

    .detail-label {
      font-weight: 600;
      min-width: 120px;
      color: var(--text-secondary);
    }

    .detail-value {
      flex: 1;
    }

    .product-image {
      width: 100px;
      height: 100px;
      background-color: var(--card-border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
    }

    .product-image i {
      font-size: 2rem;
      color: var(--text-secondary);
    }

    .product-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .product-info {
      flex: 1;
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      margin-right: 5px;
      background-color: var(--card-border);
      color: var(--text-secondary);
    }

    .tag.stock-high {
      background-color: rgba(49, 162, 76, 0.15);
      color: var(--success);
    }

    .tag.stock-low {
      background-color: rgba(247, 185, 40, 0.15);
      color: var(--warning);
    }

    .tag.stock-none {
      background-color: rgba(240, 40, 73, 0.15);
      color: var(--danger);
    }

    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .menu-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .search-container {
        display: none;
      }

      .stats-container {
        grid-template-columns: 1fr;
      }

      .quick-actions {
        grid-template-columns: 1fr;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .table-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .filter-container {
        flex-direction: column;
      }

      #product-modal .modal-content {
        width: 95%;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    [dir="rtl"] .sidebar {
      left: auto;
      right: 0;
      border-radius: 8px 0 0 8px;
    }

    [dir="rtl"] .main-content {
      margin-left: 0;
      margin-right: var(--sidebar-width);
    }

    [dir="rtl"] .menu-item {
      border-radius: 8px 0 0 8px;
    }

    [dir="rtl"] .menu-item.active::before {
      left: auto;
      right: 0;
      border-radius: 4px 0 0 4px;
    }

    [dir="rtl"] .menu-item i {
      margin-right: 0;
      margin-left: 15px;
    }

    [dir="rtl"] .profile-name {
      margin-right: 0;
      margin-left: 8px;
    }

    [dir="rtl"] .profile-img {
      margin-right: 0;
      margin-left: 8px;
    }

    [dir="rtl"] .dropdown {
      right: auto;
      left: 0;
    }

    [dir="rtl"] .search-icon {
      left: auto;
      right: 15px;
    }

    [dir="rtl"] .search-box input {
      padding: 10px 40px 10px 15px;
    }

    [dir="rtl"] .btn i {
      margin-right: 0;
      margin-left: 8px;
    }

    [dir="rtl"] .action-btn {
      margin-right: 0;
      margin-left: 8px;
    }

    [dir="rtl"] .modal-footer {
      justify-content: flex-start;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="top-navbar">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
        </div>
        <div class="logo-text">Proforma</div>
      </div>

      <div class="search-container">
        <div class="search-box">
          <div class="search-icon"><i class="fas fa-search"></i></div>
          <input type="text" placeholder="Rechercher...">
        </div>
      </div>

      <div class="nav-icons">
        <div class="nav-icon">
          <i class="fas fa-home"></i>
        </div>
        <div class="nav-icon">
          <i class="fas fa-bell"></i>
          <div class="icon-badge">3</div>
        </div>
        <div class="nav-icon">
          <i class="fas fa-cog"></i>
        </div>

        <div class="language-toggle">
          <button class="lang-btn active" data-lang="fr">FR</button>
          <button class="lang-btn" data-lang="ar">AR</button>
        </div>

        <div class="profile-menu">
          <button class="profile-btn">
            <div class="profile-img">MS</div>
            <div class="profile-name">Mustapha</div>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown">
            <a href="#" class="dropdown-item">
              <i class="fas fa-user"></i>
              <span>Mon profil</span>
            </a>
            <a href="#" class="dropdown-item">
              <i class="fas fa-cog"></i>
              <span>Paramètres</span>
            </a>
            <a href="#" class="dropdown-item" id="reset-tour">
              <i class="fas fa-sync-alt"></i>
              <span>Redémarrer le guide</span>
            </a>
            <div class="divider"></div>
            <a href="#" class="dropdown-item">
              <i class="fas fa-sign-out-alt"></i>
              <span>Déconnexion</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <aside class="sidebar">
      <ul class="sidebar-menu">
        <li>
          <a class="menu-item active" data-page="dashboard">
            <i class="fas fa-tachometer-alt"></i>
            <span class="menu-title">Tableau de bord</span>
          </a>
        </li>
        <li>
          <a class="menu-item" data-page="products">
            <i class="fas fa-box"></i>
            <span class="menu-title">Produits</span>
          </a>
        </li>
        <li>
          <a class="menu-item" data-page="invoices">
            <i class="fas fa-file-invoice"></i>
            <span class="menu-title">Factures</span>
          </a>
        </li>
        <li>
            <a class="menu-item" data-page="clients">
              <i class="fas fa-users"></i>
              <span class="menu-title">Clients</span>
            </a>
        </li>
        <li>
          <a class="menu-item" data-page="settings">
            <i class="fas fa-cog"></i>
            <span class="menu-title">Paramètres</span>
          </a>
        </li>
        <li>
          <a class="menu-item" id="open-guide">
            <i class="fas fa-book"></i>
            <span class="menu-title">Guide d'utilisation</span>
          </a>
        </li>
        <li>
          <a class="menu-item" id="open-about">
            <i class="fas fa-info-circle"></i>
            <span class="menu-title">À propos</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="theme-toggle">
          <button class="theme-btn active" data-theme="light">
            <i class="fas fa-sun"></i>
          </button>
          <button class="theme-btn" data-theme="dark">
            <i class="fas fa-moon"></i>
          </button>
        </div>

        <div class="help-box">
          <div class="help-title">
            <i class="fas fa-question-circle"></i>
            <span>Besoin d'aide?</span>
          </div>
          <div class="help-text">
            Notre équipe de support est disponible 24/7 pour répondre à vos questions.
          </div>
          <button class="help-btn">
            <i class="fas fa-headset"></i>
            Contacter le support
          </button>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <section class="page active" id="dashboard-page">
        <h1 class="page-title">
          <i class="fas fa-tachometer-alt"></i>
          Tableau de bord
        </h1>
        <p class="page-subtitle">Vue d'ensemble de votre activité et statistiques</p>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon invoices">
                <i class="fas fa-file-invoice"></i>
              </div>
              <div>
                <div class="stat-title">Factures</div>
                <div class="stat-value" id="stats-invoices">0</div>
                <div class="stat-change positive" id="stats-invoices-change">
                  <i class="fas fa-arrow-up"></i>
                  <span>0% ce mois</span>
                </div>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon products">
                <i class="fas fa-box"></i>
              </div>
              <div>
                <div class="stat-title">Produits</div>
                <div class="stat-value" id="stats-products">0</div>
                <div class="stat-change positive" id="stats-products-change">
                  <i class="fas fa-arrow-up"></i>
                  <span>0% ce mois</span>
                </div>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon revenue">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div>
                <div class="stat-title">Revenu (Payé)</div>
                <div class="stat-value" id="stats-revenue">0 DA</div>
                <div class="stat-change positive" id="stats-revenue-change">
                  <i class="fas fa-arrow-up"></i>
                  <span>0% ce mois</span>
                </div>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon clients">
                <i class="fas fa-users"></i>
              </div>
              <div>
                <div class="stat-title">Clients</div>
                <div class="stat-value" id="stats-clients">0</div>
                <div class="stat-change positive" id="stats-clients-change">
                  <i class="fas fa-arrow-up"></i>
                  <span>0% ce mois</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="recent-section">
            <div class="section-header">
                <h2 class="section-title">Ventes mensuelles</h2>
            </div>
            <canvas id="salesChart" height="100"></canvas>
        </div>

        <div class="quick-actions">
          <div class="action-card" data-action="new-invoice">
            <div class="action-icon">
              <i class="fas fa-plus"></i>
            </div>
            <h3 class="action-title">Nouvelle facture</h3>
            <p class="action-desc">Créer une nouvelle facture ou proforma</p>
          </div>

          <div class="action-card" data-action="new-product">
            <div class="action-icon">
              <i class="fas fa-box"></i>
            </div>
            <h3 class="action-title">Ajouter produit</h3>
            <p class="action-desc">Ajouter un nouveau produit au catalogue</p>
          </div>

          <div class="action-card" data-action="export-data">
            <div class="action-icon">
              <i class="fas fa-file-export"></i>
            </div>
            <h3 class="action-title">Exporter données</h3>
            <p class="action-desc">Exporter en Excel ou JSON</p>
          </div>

          <div class="action-card" data-action="go-to-settings">
            <div class="action-icon">
              <i class="fas fa-cog"></i>
            </div>
            <h3 class="action-title">Paramètres</h3>
            <p class="action-desc">Gérer les données de l'application</p>
          </div>
        </div>

        <div class="recent-section">
          <div class="section-header">
            <h2 class="section-title">Factures récentes</h2>
            <a href="#" class="view-all" data-page="invoices">Voir tout</a>
          </div>
          <ul class="invoice-list" id="recent-invoices-list">
             <!-- Recent invoices will be rendered here -->
             <p id="no-recent-invoices">Aucune facture récente.</p>
          </ul>
        </div>
      </section>

      <section class="page" id="products-page">
        <div class="page-header">
          <div>
            <h1 class="page-title">
              <i class="fas fa-box"></i>
              Gestion des produits
            </h1>
            <p class="page-subtitle">Liste complète de vos produits et services</p>
          </div>
          <div class="btn-group">
            <button class="btn" id="add-product">
              <i class="fas fa-plus"></i>
              Ajouter produit
            </button>
            <button class="btn btn-success" id="export-products">
              <i class="fas fa-file-excel"></i>
              Excel
            </button>
          </div>
        </div>

        <div class="filter-container">
          <div class="filter-group">
            <label>Recherche</label>
            <input type="text" id="product-search" placeholder="Rechercher un produit...">
          </div>
          <div class="filter-group">
            <label>Catégorie</label>
            <select id="product-category-filter">
              <option value="">Toutes les catégories</option>
              <option value="Cuisine">Cuisine</option>
              <option value="Chambre">Chambre</option>
              <option value="Salon">Salon</option>
              <option value="Aluminium">Aluminium</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Statut stock</label>
            <select id="product-stock-filter">
              <option value="">Tous</option>
              <option value="high">Stock élevé</option>
              <option value="low">Stock faible</option>
              <option value="none">Épuisé</option>
            </select>
          </div>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Catégorie</th>
                <th>Prix unitaire</th>
                <th>Unité</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="products-table-body">
              <!-- Products will be rendered here -->
            </tbody>
          </table>
        </div>
      </section>

      <section class="page" id="invoices-page">
        <div class="page-header">
          <div>
            <h1 class="page-title">
              <i class="fas fa-file-invoice"></i>
              Gestion des factures
            </h1>
            <p class="page-subtitle">Créer et gérer vos factures et proformas</p>
          </div>
          <div class="btn-group">
            <button class="btn" id="new-invoice">
              <i class="fas fa-plus"></i>
              Nouvelle facture
            </button>
            <button class="btn btn-success" id="export-invoices">
              <i class="fas fa-file-excel"></i>
              Excel
            </button>
          </div>
        </div>

        <div class="filter-container">
          <div class="filter-group">
            <label>Recherche</label>
            <input type="text" id="invoice-search" placeholder="Rechercher une facture...">
          </div>
          <div class="filter-group">
            <label>Statut</label>
            <select id="invoice-status-filter">
              <option value="">Tous les statuts</option>
              <option value="paid">Payée</option>
              <option value="pending">En attente</option>
              <option value="draft">Brouillon</option>
              <option value="delivered">Livrée</option>
              <option value="installed">Installée</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Date de début</label>
            <input type="date" id="start-date">
          </div>
          <div class="filter-group">
            <label>Date de fin</label>
            <input type="date" id="end-date">
          </div>
           <div class="filter-group">
             <button class="btn btn-secondary" id="clear-filters" style="margin-top:25px">
                <i class="fas fa-times"></i>
                Effacer
              </button>
           </div>
        </div>

        <div class="invoice-editor" id="invoice-editor" style="display: none;">
          <div class="invoice-editor-header">
            <h2 id="invoice-editor-title">Nouvelle Facture</h2>
            <div>
              <button class="btn btn-secondary" id="cancel-invoice">Annuler</button>
              <button class="btn" id="save-invoice">Enregistrer</button>
            </div>
          </div>

          <div class="form-group">
            <label>N° Facture</label>
            <input type="text" id="invoice-number" placeholder="Ex: PF-2023-00125">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
              <label>Date</label>
              <input type="date" id="invoice-date">
            </div>

            <div class="form-group">
              <label>Client</label>
              <div style="display: flex; gap: 5px;">
                <input type="text" id="invoice-client" list="client-datalist" placeholder="Nom du client" style="flex: 1;">
                <button type="button" class="btn" id="add-client-from-invoice" style="padding: 8px;">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <datalist id="client-datalist"></datalist>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
              <label>Statut</label>
              <select id="invoice-status">
                <option value="draft">Brouillon</option>
                <option value="pending">En attente</option>
                <option value="paid">Payée</option>
                <option value="delivered">Livrée</option>
                <option value="installed">Installée</option>
              </select>
            </div>
            <div class="form-group">
              <label>Mode de paiement</label>
              <select id="payment-method">
                <option value="cash">Espèces</option>
                <option value="check">Chèque</option>
                <option value="bank">Virement</option>
                <option value="card">Carte</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Description du projet</label>
            <textarea id="project-description" rows="2" placeholder="Détails sur le projet de cuisine ou meuble..."></textarea>
          </div>

          <h3>Articles</h3>
          <table class="lines-table">
            <thead>
              <tr>
                <th>Produit</th>
                <th>Description</th>
                <th>Unité</th>
                <th>Quantité</th>
                <th>Prix</th>
                <th>TVA (%)</th>
                <th>Remise (%)</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="invoice-lines">
              <!-- Invoice lines will be added here -->
            </tbody>
          </table>

          <button class="btn" id="add-line">
            <i class="fas fa-plus"></i>
            Ajouter une ligne
          </button>

          <div class="invoice-totals">
            <table class="totals-table">
              <tr>
                <td>Sous-total:</td>
                <td id="subtotal" class="mono">0.00 DA</td>
              </tr>
              <tr>
                <td>TVA:</td>
                <td id="tax-total" class="mono">0.00 DA</td>
              </tr>
              <tr>
                <td>Remise:</td>
                <td id="discount-total" class="mono">0.00 DA</td>
              </tr>
              <tr>
                <td>Total:</td>
                <td id="grand-total" class="mono">0.00 DA</td>
              </tr>
            </table>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Date de livraison</label>
              <input type="date" id="delivery-date">
            </div>
            <div class="form-group">
              <label>Statut livraison</label>
              <select id="delivery-status">
                <option value="pending">En préparation</option>
                <option value="shipped">Expédié</option>
                <option value="delivered">Livré</option>
                <option value="installed">Installé</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea id="invoice-notes" rows="3"></textarea>
          </div>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>N° Facture</th>
                <th>Client</th>
                <th>Date</th>
                <th>Montant</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoices-table-body">
              <!-- Invoices will be rendered here -->
            </tbody>
          </table>
        </div>
      </section>

      <section class="page" id="clients-page">
        <div class="page-header">
          <div>
            <h1 class="page-title">
              <i class="fas fa-users"></i>
              Gestion des clients
            </h1>
            <p class="page-subtitle">Gérer votre base de données clients</p>
          </div>
          <div class="btn-group">
            <button class="btn" id="add-client-btn">
              <i class="fas fa-plus"></i>
              Ajouter Client
            </button>
            <button class="btn btn-info" id="client-history-btn">
              <i class="fas fa-history"></i>
              Historique
            </button>
          </div>
        </div>

        <div class="filter-container">
          <div class="filter-group">
            <label>Recherche</label>
            <input type="text" id="client-search" placeholder="Rechercher un client...">
          </div>
          <div class="filter-group">
            <label>Type de client</label>
            <select id="client-type-filter">
              <option value="">Tous</option>
              <option value="particulier">Particulier</option>
              <option value="entreprise">Entreprise</option>
              <option value="architecte">Architecte</option>
            </select>
          </div>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Contact</th>
                <th>Type</th>
                <th>Dernière commande</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="clients-table-body">
              <!-- Clients will be rendered here -->
            </tbody>
          </table>
        </div>
      </section>

      <section class="page" id="settings-page">
        <h1 class="page-title">
          <i class="fas fa-cog"></i>
          Paramètres
        </h1>
        <p class="page-subtitle">Gérer les préférences et les données de l'application</p>

        <div class="settings-grid">
          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-database"></i>
              <div class="settings-card-title">Gestion des données</div>
            </div>
            <div class="settings-card-body">
              <p>Sauvegardez ou restaurez toutes les données de l'application.</p>
            </div>
            <div class="btn-group">
              <button class="btn btn-success" id="export-json">
                <i class="fas fa-file-export"></i>
                Exporter JSON
              </button>
              <button class="btn btn-secondary" id="import-json-btn">
                <i class="fas fa-file-import"></i>
                Importer JSON
              </button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;">
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-redo"></i>
              <div class="settings-card-title">Réinitialisation</div>
            </div>
            <div class="settings-card-body">
              <p>Réinitialisez les données ou restaurez les valeurs par défaut.</p>
            </div>
            <div class="btn-group">
              <button class="btn btn-warning" id="reset-data">
                <i class="fas fa-history"></i>
                Réinitialiser
              </button>
              <button class="btn btn-danger" id="clear-data">
                <i class="fas fa-trash"></i>
                Effacer données
              </button>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-cloud"></i>
              <div class="settings-card-title">Sauvegarde Cloud</div>
            </div>
            <div class="settings-card-body">
              <p>Activez la synchronisation automatique avec le cloud pour sauvegarder vos données.</p>
            </div>
            <div class="form-group">
              <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="cloud-sync" style="width: auto;">
                <label for="cloud-sync">Synchronisation automatique (Bientôt)</label>
              </div>
            </div>
            <button class="btn btn-secondary" disabled>
              <i class="fas fa-sync"></i>
              Synchroniser maintenant
            </button>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-shield-alt"></i>
              <div class="settings-card-title">Sécurité</div>
            </div>
            <div class="settings-card-body">
              <p>Modifiez votre mot de passe ou configurez l'authentification à deux facteurs.</p>
            </div>
            <div class="btn-group">
              <button class="btn btn-secondary" disabled>
                <i class="fas fa-key"></i>
                Changer mot de passe
              </button>
              <button class="btn btn-secondary" disabled>
                <i class="fas fa-lock"></i>
                2FA
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal" id="guide-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Guide d'utilisation</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>Ce logiciel permet de créer, gérer et exporter des devis/proformas pour un atelier de meubles en bois ou aluminium.</p>

        <h3>Fonctionnalités principales</h3>
        <ul>
          <li><strong>Produits :</strong> Ajoutez, modifiez ou supprimez des produits avec nom, catégorie, unité et prix.</li>
          <li><strong>Création Proforma :</strong> Remplissez les informations client, date et ajoutez des lignes d'articles.</li>
          <li><strong>Calcul automatique :</strong> Les totaux sont calculés automatiquement avec TVA et remises.</li>
          <li><strong>Historique :</strong> Consultez les proformas créées dans les 7 derniers jours.</li>
          <li><strong>Import/Export :</strong> Sauvegardez ou restaurez vos données (JSON ou Excel).</li>
          <li><strong>Impression :</strong> Imprimez directement la proforma prête à remettre au client.</li>
          <li><strong>Sauvegarde locale :</strong> Les données sont stockées dans votre navigateur, même après fermeture.</li>
        </ul>

        <h3>Conseils d'utilisation</h3>
        <ul>
          <li>Utilisez le bouton <em>Enregistrer</em> pour sauvegarder un brouillon de proforma.</li>
          <li>Vérifiez vos données avant export ou impression.</li>
          <li>Utilisez l'onglet Import/Export pour transférer vos données sur un autre appareil.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary modal-close">Fermer</button>
        <button class="btn" id="start-tour">
          <i class="fas fa-play"></i>
          Démarrer la visite guidée
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="about-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">À propos</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p><strong>Nom :</strong> Proforma Ma Cuisine</p>
        <p><strong>Version :</strong> 3.0.0 (IndexedDB Edition)</p>
        <p><strong>Description :</strong> Application SaaS pour la gestion et l'édition de devis/proformas d'atelier. Conçue pour une utilisation simple, rapide et efficace, avec synchronisation cloud.</p>
        <p><strong>Auteur :</strong> Mustapha Salhi</p>
        <p><strong>Contact :</strong> salhimustapha28@gmail.com</p>
        <p><strong>Date :</strong> Août 2025</p>

        <h3>Fonctionnalités</h3>
        <ul>
          <li>Gestion complète des produits et services</li>
          <li>Création de proformas et factures</li>
          <li>Calculs automatiques (TVA, remises, totaux)</li>
          <li>Historique des documents</li>
          <li>Export Excel et JSON</li>
          <li>Impression professionnelle</li>
          <li>Synchronisation cloud</li>
          <li>Interface multilingue (Français/Arabe)</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn modal-close">Fermer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmation-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="confirmation-title">Confirmation</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmation-message">Êtes-vous sûr de vouloir effectuer cette action?</p>
        <div class="progress-container" id="progress-container" style="display: none;">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-action">Annuler</button>
        <button class="btn" id="confirm-action">Confirmer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="product-modal-title">Nouveau Produit</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="product-form">
          <div class="form-group">
            <label>Nom du produit*</label>
            <input type="text" id="product-name" required>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label>Catégorie</label>
              <select id="product-category-input">
                <option value="">Sélectionner</option>
                <option value="Cuisine">Cuisine</option>
                <option value="Chambre">Chambre</option>
                <option value="Salon">Salon</option>
                <option value="Aluminium">Aluminium</option>
                <option value="Bureau">Bureau</option>
              </select>
            </div>

            <div class="form-group">
              <label>Unité</label>
              <select id="product-unit">
                <option value="pcs">Pièce (pcs)</option>
                <option value="ml">Mètre linéaire (ml)</option>
                <option value="m²">Mètre carré (m²)</option>
                <option value="lot">Lot</option>
              </select>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label>Prix unitaire (DA)*</label>
              <input type="number" id="product-price" min="0" step="0.01" required>
            </div>

            <div class="form-group">
              <label>TVA (%)</label>
              <input type="number" id="product-tax" min="0" max="100" step="0.1" value="19">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label>Stock initial</label>
              <input type="number" id="product-stock" min="0" value="0">
            </div>

            <div class="form-group">
              <label>Seuil d'alerte</label>
              <input type="number" id="product-threshold" min="0" value="5">
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="product-description" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-product">Annuler</button>
        <button class="btn" id="save-product-btn">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="client-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="client-modal-title">Nouveau Client</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="client-form">
                <div class="form-group">
                    <label>Nom du client*</label>
                    <input type="text" id="client-name" required>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Type de client</label>
                    <select id="client-type">
                      <option value="particulier">Particulier</option>
                      <option value="entreprise">Entreprise</option>
                      <option value="architecte">Architecte</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Téléphone</label>
                    <input type="tel" id="client-phone">
                  </div>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="client-email">
                </div>

                <div class="form-group">
                    <label>Adresse</label>
                    <textarea id="client-address" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-client-btn">Annuler</button>
            <button class="btn" id="save-client-btn">Enregistrer</button>
        </div>
    </div>
  </div>

  <div class="modal" id="client-history-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="client-history-title">Historique Client</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="client-header">
          <div class="profile-img" style="width: 60px; height: 60px; margin-right: 15px;">
            <i class="fas fa-user"></i>
          </div>
          <div>
            <h3 id="client-history-name">Client Name</h3>
            <p id="client-history-info">Contact info</p>
          </div>
        </div>

        <div class="detail-view">
          <h3>Informations client</h3>
          <div class="detail-item">
            <div class="detail-label">Type:</div>
            <div class="detail-value" id="client-type-value">Particulier</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Téléphone:</div>
            <div class="detail-value" id="client-phone-value">0550123456</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Email:</div>
            <div class="detail-value" id="client-email-value">client@example.com</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Adresse:</div>
            <div class="detail-value" id="client-address-value">Alger Centre</div>
          </div>
        </div>

        <div class="detail-view">
          <h3>Historique des commandes</h3>
          <div id="client-orders-list">
            <!-- Client orders will be listed here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn modal-close">Fermer</button>
      </div>
    </div>
  </div>

  <div id="notification-area"></div>

  <script>
    // --- UTILITY FUNCTIONS ---
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from((root || document).querySelectorAll(sel));
    const esc = s => s ? String(s).replace(/[&<>]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])) : '';
    const num = n => (Number(n || 0)).toFixed(2);
    const today = () => new Date().toISOString().slice(0, 10);
    const generateId = (prefix) => `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).substr(2, 9)}`;

    // --- NOTIFICATION SYSTEM ---
    function showNotification(message, type = 'success', duration = 3000) {
      const notificationArea = $('#notification-area');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
        <span class="close"><i class="fas fa-times"></i></span>
      `;
      notificationArea.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 10);
      const close = () => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      };
      notification.querySelector('.close').addEventListener('click', close);
      if (duration > 0) setTimeout(close, duration);
    }

    // --- INDEXEDDB DATABASE HELPER ---
    const DB_NAME = 'ProformaDB_v1';
    const DB_VERSION = 1;
    let db;

    const DB = {
      async open() {
        return new Promise((resolve, reject) => {
          if (db) return resolve(db);
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('products')) {
              const store = db.createObjectStore('products', { keyPath: 'id' });
              store.createIndex('name', 'name');
              store.createIndex('category', 'category');
              store.createIndex('stock', 'stock');
            }
            if (!db.objectStoreNames.contains('invoices')) {
              const store = db.createObjectStore('invoices', { keyPath: 'id' });
              store.createIndex('date', 'date');
              store.createIndex('client', 'client');
              store.createIndex('status', 'status');
            }
            if (!db.objectStoreNames.contains('clients')) {
              const store = db.createObjectStore('clients', { keyPath: 'id' });
              store.createIndex('name', 'name');
              store.createIndex('type', 'type');
            }
          };
          request.onsuccess = e => {
            db = e.target.result;
            resolve(db);
          };
          request.onerror = e => reject('IndexedDB error: ' + e.target.errorCode);
        });
      },
      async get(storeName, key) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const request = store.get(key);
          request.onsuccess = () => resolve(request.result);
          request.onerror = e => reject(e.target.error);
        });
      },
      async getAll(storeName) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = e => reject(e.target.error);
        });
      },
      async put(storeName, item) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const request = store.put(item);
          request.onsuccess = () => resolve(request.result);
          request.onerror = e => reject(e.target.error);
        });
      },
      async delete(storeName, key) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const request = store.delete(key);
          request.onsuccess = () => resolve();
          request.onerror = e => reject(e.target.error);
        });
      },
      async clear(storeName) {
        const db = await this.open();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const request = store.clear();
          request.onsuccess = () => resolve();
          request.onerror = e => reject(e.target.error);
        });
      }
    };

    // --- GLOBAL STATE ---
    let products = [];
    let invoices = [];
    let clients = [];
    let currentInvoice = null;
    let salesChart = null;
    let currentClientHistory = null;

    // --- DATA RENDERING FUNCTIONS ---
    async function renderAll() {
        await Promise.all([
            renderProducts(),
            renderInvoices(),
            renderClients(),
            updateDashboard()
        ]);
    }

    async function renderProducts() {
      const tbody = $('#products-table-body');
      if (!tbody) return;

      const searchTerm = $('#product-search').value.toLowerCase();
      const categoryFilter = $('#product-category-filter').value;
      const stockFilter = $('#product-stock-filter').value;

      let filteredProducts = products.filter(p => {
          const matchesSearch = !searchTerm || p.name.toLowerCase().includes(searchTerm) || (p.description || '').toLowerCase().includes(searchTerm);
          const matchesCategory = !categoryFilter || p.category === categoryFilter;

          // Stock filter
          let matchesStock = true;
          if (stockFilter) {
            if (stockFilter === 'high' && p.stock <= (p.stockThreshold || 5)) matchesStock = false;
            if (stockFilter === 'low' && (p.stock > (p.stockThreshold || 5) || p.stock === 0)) matchesStock = false;
            if (stockFilter === 'none' && p.stock > 0) matchesStock = false;
          }

          return matchesSearch && matchesCategory && matchesStock;
      });

      tbody.innerHTML = filteredProducts.map(p => {
        // Determine stock status tag
        let stockTag = '';
        if (p.stock === 0) {
          stockTag = '<span class="tag stock-none">Épuisé</span>';
        } else if (p.stock <= (p.stockThreshold || 5)) {
          stockTag = `<span class="tag stock-low">Faible (${p.stock})</span>`;
        } else {
          stockTag = `<span class="tag stock-high">Disponible (${p.stock})</span>`;
        }

        return `
        <tr>
          <td>${esc(p.name)}</td>
          <td>${esc(p.category || '')}</td>
          <td>${num(p.price)} DA</td>
          <td>${esc(p.unit || '')}</td>
          <td>${stockTag}</td>
          <td class="action-cell">
            <div class="action-btn edit-product" data-id="${p.id}"><i class="fas fa-edit"></i></div>
            <div class="action-btn delete-product" data-id="${p.id}"><i class="fas fa-trash"></i></div>
          </td>
        </tr>
        `;
      }).join('');
    }

    async function renderInvoices() {
      const tbody = $('#invoices-table-body');
      if (!tbody) return;

      const searchTerm = $('#invoice-search').value.toLowerCase();
      const statusFilter = $('#invoice-status-filter').value;
      const startDate = $('#start-date').value;
      const endDate = $('#end-date').value;

      let filteredInvoices = invoices.filter(inv => {
          const matchesSearch = !searchTerm || inv.number.toLowerCase().includes(searchTerm) || inv.client.toLowerCase().includes(searchTerm);
          const matchesStatus = !statusFilter || inv.status === statusFilter;
          const matchesStartDate = !startDate || inv.date >= startDate;
          const matchesEndDate = !endDate || inv.date <= endDate;
          return matchesSearch && matchesStatus && matchesStartDate && matchesEndDate;
      }).sort((a, b) => new Date(b.date) - new Date(a.date));

      tbody.innerHTML = filteredInvoices.map(inv => {
          const statusMap = {
              paid: { class: 'status-paid', text: 'Payée' },
              pending: { class: 'status-pending', text: 'En attente' },
              draft: { class: 'status-draft', text: 'Brouillon' },
              delivered: { class: 'status-delivered', text: 'Livrée' },
              installed: { class: 'status-installed', text: 'Installée' }
          };
          const status = statusMap[inv.status] || statusMap.draft;
          return `
            <tr>
              <td>${esc(inv.number)}</td>
              <td>${esc(inv.client)}</td>
              <td>${inv.date}</td>
              <td>${num(inv.total)} DA</td>
              <td><span class="invoice-status ${status.class}">${status.text}</span></td>
              <td class="action-cell">
                <div class="action-btn view-invoice" data-id="${inv.id}"><i class="fas fa-eye"></i></div>
                <div class="action-btn edit-invoice" data-id="${inv.id}"><i class="fas fa-edit"></i></div>
                <div class="action-btn print-invoice" data-id="${inv.id}"><i class="fas fa-print"></i></div>
                <div class="action-btn export-invoice-excel" data-id="${inv.id}"><i class="fas fa-file-excel"></i></div>
                <div class="action-btn delete-invoice" data-id="${inv.id}"><i class="fas fa-trash"></i></div>
              </td>
            </tr>
          `;
      }).join('');
    }

    async function renderClients() {
      const tbody = $('#clients-table-body');
      if (!tbody) return;

      const searchTerm = $('#client-search').value.toLowerCase();
      const typeFilter = $('#client-type-filter').value;

      let filteredClients = clients.filter(c => {
        const matchesSearch = !searchTerm || c.name.toLowerCase().includes(searchTerm) ||
                             (c.contact || '').toLowerCase().includes(searchTerm) ||
                             (c.email || '').toLowerCase().includes(searchTerm);
        const matchesType = !typeFilter || c.type === typeFilter;
        return matchesSearch && matchesType;
      });

      // Get last order date for each client
      const clientLastOrder = {};
      invoices.forEach(inv => {
        if (!clientLastOrder[inv.client] || new Date(inv.date) > new Date(clientLastOrder[inv.client])) {
          clientLastOrder[inv.client] = inv.date;
        }
      });

      tbody.innerHTML = filteredClients.map(c => {
        const typeMap = {
          particulier: 'Particulier',
          entreprise: 'Entreprise',
          architecte: 'Architecte'
        };

        const lastOrder = clientLastOrder[c.name] || 'Aucune';

        return `
          <tr>
            <td>${esc(c.name)}</td>
            <td>${esc(c.phone || '')}</td>
            <td>${typeMap[c.type] || c.type}</td>
            <td>${lastOrder}</td>
            <td class="action-cell">
              <div class="action-btn view-client" data-id="${c.id}"><i class="fas fa-eye"></i></div>
              <div class="action-btn edit-client" data-id="${c.id}"><i class="fas fa-edit"></i></div>
              <div class="action-btn delete-client" data-id="${c.id}"><i class="fas fa-trash"></i></div>
            </td>
          </tr>
        `;
      }).join('');

      const datalist = $('#client-datalist');
      datalist.innerHTML = clients.map(c => `<option value="${esc(c.name)}"></option>`).join('');
    }

    // --- DASHBOARD & STATISTICS ---
    async function updateDashboard() {
        await updateDashboardStats();
        await renderRecentInvoices();
        await renderSalesChart();
    }

    async function updateDashboardStats() {
        // Invoices
        const totalInvoices = invoices.length;
        $('#stats-invoices').textContent = totalInvoices;

        // Products
        const totalProducts = products.length;
        $('#stats-products').textContent = totalProducts;

        // Revenue
        const totalRevenue = invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + inv.total, 0);
        $('#stats-revenue').textContent = `${num(totalRevenue)} DA`;

        // Clients
        const uniqueClients = new Set(invoices.map(inv => inv.client.trim())).size;
        $('#stats-clients').textContent = uniqueClients;

        // --- Monthly change calculations ---
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);

        const currentMonthRevenue = invoices
            .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfMonth)
            .reduce((sum, inv) => sum + inv.total, 0);

        const lastMonthRevenue = invoices
            .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfLastMonth && new Date(inv.date) <= endOfLastMonth)
            .reduce((sum, inv) => sum + inv.total, 0);

        updateStatChange($('#stats-revenue-change'), currentMonthRevenue, lastMonthRevenue);

        const currentMonthInvoices = invoices.filter(inv => new Date(inv.date) >= startOfMonth).length;
        const lastMonthInvoices = invoices.filter(inv => new Date(inv.date) >= startOfLastMonth && new Date(inv.date) <= endOfLastMonth).length;
        updateStatChange($('#stats-invoices-change'), currentMonthInvoices, lastMonthInvoices, false);
    }

    function updateStatChange(element, current, previous, isCurrency = true) {
        let percentage;
        if (previous > 0) {
            percentage = ((current - previous) / previous) * 100;
        } else if (current > 0) {
            percentage = 100;
        } else {
            percentage = 0;
        }

        element.classList.remove('positive', 'negative', 'neutral');
        const icon = element.querySelector('i');
        const text = element.querySelector('span');

        if (percentage > 0) {
            element.classList.add('positive');
            icon.className = 'fas fa-arrow-up';
        } else if (percentage < 0) {
            element.classList.add('negative');
            icon.className = 'fas fa-arrow-down';
        } else {
            element.classList.add('neutral');
            icon.className = 'fas fa-minus';
        }
        text.textContent = `${percentage.toFixed(0)}% ce mois`;
    }

    async function renderRecentInvoices() {
        const list = $('#recent-invoices-list');
        const noItems = $('#no-recent-invoices');
        const recent = invoices.slice(0, 5);
        if (recent.length > 0) {
            noItems.style.display = 'none';
            list.innerHTML = recent.map(inv => {
                const statusMap = {
                    paid: { class: 'status-paid', text: 'Payée' },
                    pending: { class: 'status-pending', text: 'En attente' },
                    draft: { class: 'status-draft', text: 'Brouillon' },
                    delivered: { class: 'status-delivered', text: 'Livrée' },
                    installed: { class: 'status-installed', text: 'Installée' }
                };
                const status = statusMap[inv.status] || statusMap.draft;
                return `
                <li class="invoice-item">
                  <div class="invoice-info">
                    <div class="invoice-number">${esc(inv.number)}</div>
                    <div class="invoice-client">${esc(inv.client)}</div>
                  </div>
                  <div class="invoice-date">${inv.date}</div>
                  <div class="invoice-amount">${num(inv.total)} DA</div>
                  <div class="invoice-status ${status.class}">${status.text}</div>
                </li>
                `;
            }).join('');
        } else {
            noItems.style.display = 'block';
            list.innerHTML = '';
        }
    }

    async function renderSalesChart() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const salesData = invoices
            .filter(inv => inv.status === 'paid')
            .reduce((acc, inv) => {
                const month = inv.date.substring(0, 7); // YYYY-MM
                acc[month] = (acc[month] || 0) + inv.total;
                return acc;
            }, {});

        const sortedMonths = Object.keys(salesData).sort();
        const labels = sortedMonths.map(month => new Date(month + '-02').toLocaleString('fr-FR', { month: 'long', year: 'numeric' }));
        const data = sortedMonths.map(month => salesData[month]);

        if (salesChart) {
            salesChart.destroy();
        }

        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenu mensuel (Payé)',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return value.toLocaleString('fr-FR') + ' DA';
                            }
                        }
                    }
                }
            }
        });
    }

    // --- INVOICE EDITOR LOGIC ---
    function calculateTotals() {
      if (!currentInvoice) return;
      let subtotal = 0, taxTotal = 0, discountTotal = 0;
      currentInvoice.lines.forEach(line => {
        const lineTotal = (line.quantity || 0) * (line.price || 0);
        subtotal += lineTotal;
        taxTotal += lineTotal * ((line.tax || 0) / 100);
        discountTotal += lineTotal * ((line.discount || 0) / 100);
      });
      const grandTotal = subtotal + taxTotal - discountTotal;
      $('#subtotal').textContent = `${num(subtotal)} DA`;
      $('#tax-total').textContent = `${num(taxTotal)} DA`;
      $('#discount-total').textContent = `${num(discountTotal)} DA`;
      $('#grand-total').textContent = `${num(grandTotal)} DA`;
      currentInvoice.subtotal = subtotal;
      currentInvoice.tax = taxTotal;
      currentInvoice.discount = discountTotal;
      currentInvoice.total = grandTotal;
    }

    function renderInvoiceEditor() {
      if (!currentInvoice) return;
      const linesBody = $('#invoice-lines');
      linesBody.innerHTML = currentInvoice.lines.map((line, idx) => `
        <tr>
          <td>
            <select class="product-select" data-idx="${idx}">
              <option value="">Sélectionner un produit</option>
              ${products.map(p => `<option value="${p.id}" ${line.productId === p.id ? 'selected' : ''}>${esc(p.name)}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" class="description" data-idx="${idx}" value="${esc(line.description)}"></td>
          <td><input type="text" class="unit" data-idx="${idx}" value="${esc(line.unit)}"></td>
          <td><input type="number" class="quantity" data-idx="${idx}" min="0" step="0.01" value="${line.quantity}"></td>
          <td><input type="number" class="price" data-idx="${idx}" min="0" step="0.01" value="${line.price}"></td>
          <td><input type="number" class="tax" data-idx="${idx}" min="0" max="100" step="0.1" value="${line.tax}"></td>
          <td><input type="number" class="discount" data-idx="${idx}" min="0" max="100" step="0.1" value="${line.discount}"></td>
          <td class="line-total">${num((line.quantity||0) * (line.price||0))} DA</td>
          <td><button class="del-btn delete-line" data-idx="${idx}">✕</button></td>
        </tr>
      `).join('');
      calculateTotals();
    }

    async function saveCurrentInvoice() {
      if (!currentInvoice) return;
      currentInvoice.number = $('#invoice-number').value || '';
      currentInvoice.date = $('#invoice-date').value || today();
      currentInvoice.client = $('#invoice-client').value || '';
      currentInvoice.status = $('#invoice-status').value || 'draft';
      currentInvoice.paymentMethod = $('#payment-method').value || 'cash';
      currentInvoice.projectDescription = $('#project-description').value || '';
      currentInvoice.deliveryDate = $('#delivery-date').value || '';
      currentInvoice.deliveryStatus = $('#delivery-status').value || 'pending';
      currentInvoice.notes = $('#invoice-notes').value || '';

      if (!currentInvoice.id) {
        currentInvoice.id = generateId('inv');
        currentInvoice.createdAt = new Date().toISOString();
        currentInvoice.status = 'draft';
      }

      // Add client if new
      const clientName = currentInvoice.client.trim();
      if (clientName && !clients.some(c => c.name === clientName)) {
          const newClient = {
            id: generateId('client'),
            name: clientName,
            type: 'particulier'
          };
          await DB.put('clients', newClient);
          clients.push(newClient);
          await renderClients();
      }

      await DB.put('invoices', currentInvoice);
      invoices = await DB.getAll('invoices');
      hideInvoiceEditor();
      await renderAll();
      showNotification('Facture enregistrée avec succès!');
    }

    function showInvoiceEditor(invoice = null) {
      if (invoice) {
        currentInvoice = JSON.parse(JSON.stringify(invoice)); // Deep copy
        $('#invoice-editor-title').textContent = 'Modifier Facture';
      } else {
        currentInvoice = {
          id: null, number: '', date: today(), client: '', notes: '', status: 'draft',
          paymentMethod: 'cash', projectDescription: '',
          deliveryDate: '', deliveryStatus: 'pending',
          lines: [{ productId: '', description: '', unit: 'pcs', quantity: 1, price: 0, tax: 19, discount: 0 }],
          subtotal: 0, tax: 0, discount: 0, total: 0
        };
        $('#invoice-editor-title').textContent = 'Nouvelle Facture';
      }
      $('#invoice-number').value = currentInvoice.number;
      $('#invoice-date').value = currentInvoice.date;
      $('#invoice-client').value = currentInvoice.client;
      $('#invoice-status').value = currentInvoice.status;
      $('#payment-method').value = currentInvoice.paymentMethod || 'cash';
      $('#project-description').value = currentInvoice.projectDescription || '';
      $('#delivery-date').value = currentInvoice.deliveryDate || '';
      $('#delivery-status').value = currentInvoice.deliveryStatus || 'pending';
      $('#invoice-notes').value = currentInvoice.notes;
      renderInvoiceEditor();
      $('#invoice-editor').style.display = 'block';
      $('#invoice-editor').scrollIntoView({ behavior: 'smooth' });
    }

    function hideInvoiceEditor() {
      $('#invoice-editor').style.display = 'none';
      currentInvoice = null;
    }

    // --- CLIENT HISTORY VIEW ---
    async function showClientHistory(id) {
      const client = clients.find(c => c.id === id);
      if (!client) return;

      currentClientHistory = client;

      // Set client details
      $('#client-history-name').textContent = client.name;
      $('#client-type-value').textContent = client.type === 'particulier' ? 'Particulier' :
                                           client.type === 'entreprise' ? 'Entreprise' :
                                           client.type === 'architecte' ? 'Architecte' : client.type;
      $('#client-phone-value').textContent = client.phone || 'Non spécifié';
      $('#client-email-value').textContent = client.email || 'Non spécifié';
      $('#client-address-value').textContent = client.address || 'Non spécifié';

      // Get client orders
      const clientInvoices = invoices.filter(inv => inv.client === client.name)
                                    .sort((a, b) => new Date(b.date) - new Date(a.date));

      // Update client info
      let clientInfo = client.phone || '';
      if (client.email) {
        clientInfo += clientInfo ? ` | ${client.email}` : client.email;
      }
      $('#client-history-info').textContent = clientInfo;

      // Render orders
      const ordersList = $('#client-orders-list');
      if (clientInvoices.length > 0) {
        ordersList.innerHTML = `
          <table class="table" style="width:100%">
            <thead>
              <tr>
                <th>N° Facture</th>
                <th>Date</th>
                <th>Montant</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              ${clientInvoices.map(inv => {
                const statusMap = {
                  paid: { class: 'status-paid', text: 'Payée' },
                  pending: { class: 'status-pending', text: 'En attente' },
                  draft: { class: 'status-draft', text: 'Brouillon' },
                  delivered: { class: 'status-delivered', text: 'Livrée' },
                  installed: { class: 'status-installed', text: 'Installée' }
                };
                const status = statusMap[inv.status] || statusMap.draft;
                return `
                <tr>
                  <td>${esc(inv.number)}</td>
                  <td>${inv.date}</td>
                  <td>${num(inv.total)} DA</td>
                  <td><span class="invoice-status ${status.class}">${status.text}</span></td>
                </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } else {
        ordersList.innerHTML = '<p>Aucune commande pour ce client.</p>';
      }

      $('#client-history-modal').classList.add('active');
    }

    // --- MODAL & CONFIRMATION DIALOGS ---
    function showConfirmation(title, message, confirmCallback) {
      const modal = $('#confirmation-modal');
      $('#confirmation-title').textContent = title;
      $('#confirmation-message').textContent = message;

      const confirmBtn = $('#confirm-action');
      const cancelBtn = $('#cancel-action');

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

      newConfirmBtn.addEventListener('click', () => {
        modal.classList.remove('active');
        confirmCallback();
      });

      cancelBtn.onclick = () => modal.classList.remove('active');
      modal.classList.add('active');
    }

    function showProductModal(product = null) {
      const modal = $('#product-modal');
      const title = $('#product-modal-title');
      if (product) {
        title.textContent = 'Modifier Produit';
        $('#product-name').value = product.name;
        $('#product-category-input').value = product.category || '';
        $('#product-unit').value = product.unit || 'pcs';
        $('#product-price').value = product.price;
        $('#product-tax').value = product.tax || 19;
        $('#product-stock').value = product.stock || 0;
        $('#product-threshold').value = product.stockThreshold || 5;
        $('#product-description').value = product.description || '';
        $('#save-product-btn').dataset.id = product.id;
      } else {
        title.textContent = 'Nouveau Produit';
        $('#product-form').reset();
        $('#product-tax').value = 19;
        $('#product-stock').value = 0;
        $('#product-threshold').value = 5;
        delete $('#save-product-btn').dataset.id;
      }
      modal.classList.add('active');
    }

    function showClientModal(client = null) {
        const modal = $('#client-modal');
        if (client) {
            $('#client-modal-title').textContent = 'Modifier Client';
            $('#client-name').value = client.name;
            $('#client-type').value = client.type || 'particulier';
            $('#client-phone').value = client.phone || '';
            $('#client-email').value = client.email || '';
            $('#client-address').value = client.address || '';
            $('#save-client-btn').dataset.id = client.id;
        } else {
            $('#client-modal-title').textContent = 'Nouveau Client';
            $('#client-form').reset();
            delete $('#save-client-btn').dataset.id;
        }
        modal.classList.add('active');
    }

    // --- DATA MANIPULATION ---
    async function saveProduct() {
      const id = $('#save-product-btn').dataset.id;
      const name = $('#product-name').value.trim();
      if (!name) {
        showNotification('Le nom du produit est requis!', 'error');
        return;
      }
      const productData = {
        id: id || generateId('prod'),
        name: name,
        category: $('#product-category-input').value,
        unit: $('#product-unit').value,
        price: parseFloat($('#product-price').value) || 0,
        tax: parseFloat($('#product-tax').value) || 0,
        stock: parseInt($('#product-stock').value) || 0,
        stockThreshold: parseInt($('#product-threshold').value) || 5,
        description: $('#product-description').value.trim()
      };
      await DB.put('products', productData);
      products = await DB.getAll('products');
      await renderProducts();
      $('#product-modal').classList.remove('active');
      showNotification(`Produit ${id ? 'modifié' : 'ajouté'} avec succès!`);
    }

    async function saveClient() {
        const id = $('#save-client-btn').dataset.id;
        const name = $('#client-name').value.trim();
        if (!name) {
            showNotification('Le nom du client est requis!', 'error');
            return;
        }
        const clientData = {
            id: id || generateId('client'),
            name: name,
            type: $('#client-type').value || 'particulier',
            phone: $('#client-phone').value.trim(),
            email: $('#client-email').value.trim(),
            address: $('#client-address').value.trim()
        };
        await DB.put('clients', clientData);
        clients = await DB.getAll('clients');
        await renderClients();
        $('#client-modal').classList.remove('active');
        showNotification(`Client ${id ? 'modifié' : 'ajouté'} avec succès!`);
    }

    // --- PRINT & EXPORT ---
    function printInvoice(id) {
        const invoice = invoices.find(inv => inv.id === id);
        if (!invoice) return;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html><html><head><title>Facture ${invoice.number}</title><style>
                body { font-family: Arial, sans-serif; margin: 20px; } .header { text-align: center; margin-bottom: 30px; }
                .info-table, .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .info-table td, .items-table th, .items-table td { padding: 8px; border: 1px solid #ddd; }
                .items-table th { background-color: #f2f2f2; } .totals-table { float: right; width: 300px; }
                .totals-table td { padding: 8px; } .totals-table td:first-child { text-align: right; font-weight: bold; }
                .project-desc { margin: 20px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; }
            </style></head><body>
            <div class="header"><h1>FACTURE PROFORMA</h1></div>
            <table class="info-table"><tr><td><strong>N°:</strong> ${esc(invoice.number)}<br><strong>Date:</strong> ${invoice.date}</td>
            <td><strong>Client:</strong> ${esc(invoice.client)}<br><strong>Mode paiement:</strong> ${invoice.paymentMethod === 'cash' ? 'Espèces' : invoice.paymentMethod === 'check' ? 'Chèque' : invoice.paymentMethod === 'bank' ? 'Virement' : 'Carte'}</td></tr></table>

            ${invoice.projectDescription ? `<div class="project-desc"><strong>Description du projet:</strong><br>${esc(invoice.projectDescription)}</div>` : ''}

            <table class="items-table"><thead><tr><th>Désignation</th><th>Qté</th><th>Prix U.</th><th>Total</th></tr></thead><tbody>
            ${invoice.lines.map(line => `<tr><td>${esc(line.description)}</td><td>${line.quantity}</td><td>${num(line.price)} DA</td><td>${num(line.quantity * line.price)} DA</td></tr>`).join('')}
            </tbody></table>
            <table class="totals-table">
                <tr><td>Sous-total:</td><td>${num(invoice.subtotal)} DA</td></tr>
                <tr><td>TVA:</td><td>${num(invoice.tax)} DA</td></tr>
                <tr><td>Remise:</td><td>-${num(invoice.discount)} DA</td></tr>
                <tr><td><strong>TOTAL:</strong></td><td><strong>${num(invoice.total)} DA</strong></td></tr>
            </table>
            ${invoice.deliveryDate ? `<p><strong>Date de livraison prévue:</strong> ${invoice.deliveryDate}</p>` : ''}
            ${invoice.notes ? `<p><strong>Notes:</strong> ${esc(invoice.notes)}</p>` : ''}
            <script>window.onload = () => { window.print(); window.close(); }<\/script>
            </body></html>
        `);
        printWindow.document.close();
    }

    function exportInvoiceToExcel(id) {
        const invoice = invoices.find(inv => inv.id === id);
        if (!invoice) return;

        try {
            const client = clients.find(c => c.name === invoice.client) || {};

            const header = [
                ["Facture Proforma"],
                [],
                ["Client:", invoice.client],
                ["Contact:", client.phone || ''],
                ["Adresse:", client.address || ''],
                [],
                ["N° Facture:", invoice.number],
                ["Date:", invoice.date],
                ["Description du projet:", invoice.projectDescription || '']
            ];

            const linesHeader = ["Désignation", "Unité", "Quantité", "Prix Unitaire HT", "TVA (%)", "Remise (%)", "Total HT"];
            const lines = invoice.lines.map(line => [
                line.description,
                line.unit,
                line.quantity,
                line.price,
                line.tax,
                line.discount,
                (line.quantity * line.price) * (1 - (line.discount / 100))
            ]);

            const totals = [
                [],
                [null, null, null, null, null, "Sous-total HT:", invoice.subtotal],
                [null, null, null, null, null, "TVA:", invoice.tax],
                [null, null, null, null, null, "Remise:", -invoice.discount],
                [null, null, null, null, null, "Total TTC:", invoice.total],
            ];

            const deliveryInfo = [
                [],
                ["Date de livraison:", invoice.deliveryDate || 'Non spécifiée'],
                ["Statut de livraison:", invoice.deliveryStatus === 'pending' ? 'En préparation' :
                                        invoice.deliveryStatus === 'shipped' ? 'Expédié' :
                                        invoice.deliveryStatus === 'delivered' ? 'Livré' :
                                        invoice.deliveryStatus === 'installed' ? 'Installé' : invoice.deliveryStatus]
            ];

            const notes = [
                [],
                ["Notes:", invoice.notes || '']
            ];

            const worksheet = XLSX.utils.aoa_to_sheet(header);
            XLSX.utils.sheet_add_aoa(worksheet, [linesHeader], { origin: "A12" });
            XLSX.utils.sheet_add_json(worksheet, lines, { origin: "A13", skipHeader: true });

            const finalData = XLSX.utils.sheet_to_json(worksheet, {header:1});
            const lastRow = finalData.length;

            XLSX.utils.sheet_add_aoa(worksheet, totals, { origin: `G${lastRow + 2}` });
            XLSX.utils.sheet_add_aoa(worksheet, deliveryInfo, { origin: `A${lastRow + 7}` });
            XLSX.utils.sheet_add_aoa(worksheet, notes, { origin: `A${lastRow + 10}` });

            worksheet["A1"].s = { font: { sz: 16, bold: true } };
            worksheet["!cols"] = [ {wch:40}, {wch:10}, {wch:10}, {wch:15}, {wch:10}, {wch:10}, {wch:15} ];

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, `Facture ${invoice.number}`);
            XLSX.writeFile(workbook, `Facture_${invoice.number}.xlsx`);
            showNotification('Facture exportée avec succès!');
        } catch (e) {
            showNotification('Erreur lors de l\'export: ' + e.message, 'error');
        }
    }


    async function exportProductsToExcel() {
      try {
        const worksheet = XLSX.utils.json_to_sheet(products.map(p => ({
          'Nom': p.name,
          'Catégorie': p.category || '',
          'Prix unitaire': p.price,
          'Unité': p.unit || '',
          'TVA (%)': p.tax || 0,
          'Stock': p.stock || 0,
          'Seuil alerte': p.stockThreshold || 5,
          'Description': p.description || ''
        })));
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Produits');
        XLSX.writeFile(workbook, 'produits.xlsx');
        showNotification('Produits exportés avec succès!');
      } catch (e) {
        showNotification('Erreur lors de l\'export: ' + e.message, 'error');
      }
    }

    async function exportInvoicesToExcel() {
      try {
        const worksheet = XLSX.utils.json_to_sheet(invoices.map(inv => ({
          'N° Facture': inv.number,
          'Client': inv.client,
          'Date': inv.date,
          'Montant': inv.total,
          'Statut': inv.status === 'paid' ? 'Payée' : inv.status === 'pending' ? 'En attente' : inv.status === 'draft' ? 'Brouillon' : inv.status === 'delivered' ? 'Livrée' : 'Installée',
          'Mode paiement': inv.paymentMethod === 'cash' ? 'Espèces' : inv.paymentMethod === 'check' ? 'Chèque' : inv.paymentMethod === 'bank' ? 'Virement' : 'Carte',
          'Description projet': inv.projectDescription || ''
        })));
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Factures');
        XLSX.writeFile(workbook, 'factures.xlsx');
        showNotification('Factures exportées avec succès!');
      } catch (e) {
        showNotification('Erreur lors de l\'export: ' + e.message, 'error');
      }
    }

    async function exportToJSON() {
        const data = {
            products: await DB.getAll('products'),
            invoices: await DB.getAll('invoices'),
            clients: await DB.getAll('clients'),
            exportedAt: new Date().toISOString(),
            version: '3.0.0'
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `proforma_backup_${today()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Données exportées en JSON avec succès!');
    }

    function importFromJSON(file) {
        showConfirmation('Importer des données?', 'Cela écrasera vos données actuelles. Êtes-vous sûr?', async () => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.products && data.invoices && data.clients) {
                        await DB.clear('products');
                        await DB.clear('invoices');
                        await DB.clear('clients');
                        for (const p of data.products) await DB.put('products', p);
                        for (const i of data.invoices) await DB.put('invoices', i);
                        for (const c of data.clients) await DB.put('clients', c);
                        await loadInitialData();
                        showNotification('Données importées avec succès!');
                    } else {
                        showNotification('Format de fichier invalide', 'error');
                    }
                } catch (err) {
                    showNotification('Erreur lors de l\'importation: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        });
    }

    // --- INITIALIZATION & EVENT LISTENERS ---
    function setupEventListeners() {
      // Navigation
      $$('.menu-item, .view-all').forEach(item => {
        item.addEventListener('click', e => {
          e.preventDefault();
          const page = item.dataset.page;
          if (!page) return;
          $$('.page').forEach(p => p.classList.remove('active'));
          $$('.menu-item').forEach(m => m.classList.remove('active'));
          $(`#${page}-page`).classList.add('active');
          $(`.menu-item[data-page="${page}"]`).classList.add('active');
        });
      });

      // Quick actions
      $$('.action-card').forEach(card => {
        card.addEventListener('click', () => {
          const action = card.dataset.action;
          if (action === 'new-invoice') $('#new-invoice').click();
          if (action === 'new-product') $('#add-product').click();
          if (action === 'export-data') $('#export-json').click();
          if (action === 'go-to-settings') $(`.menu-item[data-page="settings"]`).click();
        });
      });

      // Theme & Language
      $$('.theme-btn').forEach(btn => btn.addEventListener('click', () => {
        document.documentElement.setAttribute('data-theme', btn.dataset.theme);
        $$('.theme-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }));
      $$('.lang-btn').forEach(btn => btn.addEventListener('click', () => {
        document.documentElement.setAttribute('dir', btn.dataset.lang === 'ar' ? 'rtl' : 'ltr');
        $$('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }));

      // Dropdown & Modals
      $('.profile-btn').addEventListener('click', () => $('.dropdown').classList.toggle('show'));
      document.addEventListener('click', e => { if (!e.target.closest('.profile-menu')) $('.dropdown').classList.remove('show'); });
      $('#open-guide').addEventListener('click', () => $('#guide-modal').classList.add('active'));
      $('#open-about').addEventListener('click', () => $('#about-modal').classList.add('active'));
      $$('.modal-close').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal').classList.remove('active')));

      // Products Page
      $('#add-product').addEventListener('click', () => showProductModal());
      $('#export-products').addEventListener('click', exportProductsToExcel);
      $('#product-search, #product-category-filter, #product-stock-filter').addEventListener('input', renderProducts);
      $('#products-table-body').addEventListener('click', e => {
        const editBtn = e.target.closest('.edit-product');
        const delBtn = e.target.closest('.delete-product');
        if (editBtn) showProductModal(products.find(p => p.id === editBtn.dataset.id));
        if (delBtn) showConfirmation('Supprimer ce produit?', 'Cette action est irréversible.', async () => {
            await DB.delete('products', delBtn.dataset.id);
            products = await DB.getAll('products');
            await renderAll();
            showNotification('Produit supprimé.');
        });
      });
      $('#save-product-btn').addEventListener('click', saveProduct);
      $('#cancel-product').addEventListener('click', () => $('#product-modal').classList.remove('active'));

      // Invoices Page
      $('#new-invoice').addEventListener('click', () => showInvoiceEditor());
      $('#export-invoices').addEventListener('click', exportInvoicesToExcel);
      $('#invoice-search, #invoice-status-filter, #start-date, #end-date').addEventListener('input', renderInvoices);
      $('#clear-filters').addEventListener('click', () => {
        $('#invoice-search').value = ''; $('#invoice-status-filter').value = '';
        $('#start-date').value = ''; $('#end-date').value = '';
        renderInvoices();
      });
      $('#invoices-table-body').addEventListener('click', e => {
        const viewBtn = e.target.closest('.view-invoice');
        const editBtn = e.target.closest('.edit-invoice');
        const printBtn = e.target.closest('.print-invoice');
        const delBtn = e.target.closest('.delete-invoice');
        const exportBtn = e.target.closest('.export-invoice-excel');

        const id = (viewBtn || editBtn || printBtn || delBtn || exportBtn)?.dataset.id;
        if (!id) return;

        if (viewBtn || editBtn) showInvoiceEditor(invoices.find(inv => inv.id === id));
        if (printBtn) printInvoice(id);
        if (exportBtn) exportInvoiceToExcel(id);
        if (delBtn) showConfirmation('Supprimer cette facture?', 'Cette action est irréversible.', async () => {
            await DB.delete('invoices', id);
            invoices = await DB.getAll('invoices');
            await renderAll();
            showNotification('Facture supprimée.');
        });
      });

      // Invoice Editor
      $('#cancel-invoice').addEventListener('click', hideInvoiceEditor);
      $('#save-invoice').addEventListener('click', saveCurrentInvoice);
      $('#add-line').addEventListener('click', () => {
        if (!currentInvoice) return;
        currentInvoice.lines.push({ productId: '', description: '', unit: 'pcs', quantity: 1, price: 0, tax: 19, discount: 0 });
        renderInvoiceEditor();
      });
      $('#invoice-lines').addEventListener('input', e => {
        if (!currentInvoice) return;
        const input = e.target;
        const idx = parseInt(input.dataset.idx);
        const field = input.className;
        if (field === 'product-select') {
          const product = products.find(p => p.id === input.value);
          if (product) {
            currentInvoice.lines[idx].productId = product.id;
            currentInvoice.lines[idx].description = product.name;
            currentInvoice.lines[idx].unit = product.unit;
            currentInvoice.lines[idx].price = product.price;
            currentInvoice.lines[idx].tax = product.tax;
          }
          renderInvoiceEditor();
        } else {
          currentInvoice.lines[idx][field] = input.type === 'number' ? parseFloat(input.value) : input.value;
          calculateTotals();
        }
      });
      $('#invoice-lines').addEventListener('click', e => {
        const delBtn = e.target.closest('.delete-line');
        if (delBtn && currentInvoice) {
          currentInvoice.lines.splice(parseInt(delBtn.dataset.idx), 1);
          renderInvoiceEditor();
        }
      });

      // Add client from invoice editor
      $('#add-client-from-invoice').addEventListener('click', () => {
        showClientModal();
      });

      // Clients Page
      $('#add-client-btn').addEventListener('click', () => showClientModal());
      $('#save-client-btn').addEventListener('click', saveClient);
      $('#cancel-client-btn').addEventListener('click', () => $('#client-modal').classList.remove('active'));
      $('#clients-table-body').addEventListener('click', e => {
          const viewBtn = e.target.closest('.view-client');
          const editBtn = e.target.closest('.edit-client');
          const delBtn = e.target.closest('.delete-client');

          if (viewBtn) showClientHistory(viewBtn.dataset.id);
          if (editBtn) showClientModal(clients.find(c => c.id === editBtn.dataset.id));
          if (delBtn) showConfirmation('Supprimer ce client?', 'Cette action est irréversible.', async () => {
              await DB.delete('clients', delBtn.dataset.id);
              clients = await DB.getAll('clients');
              await renderAll();
              showNotification('Client supprimé.');
          });
      });

      // Client history button
      $('#client-history-btn').addEventListener('click', () => {
        if (clients.length === 0) {
          showNotification('Aucun client disponible', 'warning');
          return;
        }
        showClientHistory(clients[0].id);
      });

      // Settings Page
      $('#export-json').addEventListener('click', exportToJSON);
      $('#import-json-btn').addEventListener('click', () => $('#import-file').click());
      $('#import-file').addEventListener('change', e => { if (e.target.files.length) importFromJSON(e.target.files[0]); });
      $('#clear-data').addEventListener('click', () => {
        showConfirmation('Effacer toutes les données?', 'Cette action est irréversible.', async () => {
            await DB.clear('products');
            await DB.clear('invoices');
            await DB.clear('clients');
            await loadInitialData();
            showNotification('Toutes les données ont été effacées!');
        });
      });
      $('#reset-data').addEventListener('click', () => {
        showConfirmation('Réinitialiser les données?', 'Ceci restaurera les données de démonstration.', async () => {
            await DB.clear('products');
            await DB.clear('invoices');
            await DB.clear('clients');
            await addDefaultData();
            await loadInitialData();
            showNotification('Données réinitialisées avec succès!');
        });
      });
    }

    async function addDefaultData() {
        const defaultProducts = [
          { id: 'p_1', name: 'Caisson cuisine 60cm', category: 'Cuisine', unit: 'pcs', price: 18000, tax: 19, stock: 15, stockThreshold: 5 },
          { id: 'p_2', name: 'Armoire 2 portes', category: 'Chambre', unit: 'pcs', price: 42000, tax: 19, stock: 8, stockThreshold: 3 },
          { id: 'p_3', name: 'Meuble TV 140cm', category: 'Salon', unit: 'pcs', price: 32000, tax: 19, stock: 3, stockThreshold: 5 },
        ];

        const defaultClients = [
            { id: 'c_1', name: 'Restaurant El Bahdja', type: 'entreprise', phone: '0550123456', email: 'contact@elbahdja.com', address: 'Alger Centre' },
            { id: 'c_2', name: 'Hôtel Mazafran', type: 'entreprise', phone: '021987654', email: 'info@hotelmazafran.dz', address: 'Zeralda' },
            { id: 'c_3', name: 'M. Ahmed Benali', type: 'particulier', phone: '0770123456', address: 'Hussein Dey' }
        ];

        const defaultInvoices = [
          { id: 'inv_1', number: 'PF-2023-001', date: '2023-08-14', client: 'Restaurant El Bahdja', status: 'paid',
            paymentMethod: 'bank', projectDescription: 'Cuisine professionnelle en aluminium avec îlot central',
            lines: [{ productId: 'p_1', description: 'Caisson cuisine 60cm', unit: 'pcs', quantity: 4, price: 18000, tax: 19, discount: 0 }],
            subtotal: 72000, tax: 13680, discount: 0, total: 85680 },
          { id: 'inv_2', number: 'PF-2023-002', date: '2023-08-12', client: 'Hôtel Mazafran', status: 'delivered',
            paymentMethod: 'check', projectDescription: 'Chambres équipées avec armoires et bureaux',
            lines: [{ productId: 'p_2', description: 'Armoire 2 portes', unit: 'pcs', quantity: 2, price: 42000, tax: 19, discount: 0 }],
            subtotal: 84000, tax: 15960, discount: 0, total: 99960 }
        ];

        for (const p of defaultProducts) await DB.put('products', p);
        for (const c of defaultClients) await DB.put('clients', c);
        for (const i of defaultInvoices) await DB.put('invoices', i);
    }

async function loadInitialData() {
        [products, invoices, clients] = await Promise.all([
            DB.getAll('products'),
            DB.getAll('invoices'),
            DB.getAll('clients')
        ]);
        if (products.length === 0 && invoices.length === 0) {
            await addDefaultData();
            [products, invoices, clients] = await Promise.all([
                DB.getAll('products'),
                DB.getAll('invoices'),
                DB.getAll('clients')
            ]);
        }
        await renderAll();
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', async () => {
        setupEventListeners();
        await loadInitialData();
    });
  </script>
</body>
</ht
